#/bin/sh
rvm use 1.9.3
rvm gemset use puppet-forge-api

dropdb --host=localhost --port=5432 --username=puppetforge --no-password puppetforge_test > /dev/null
createdb --host=localhost --port=5432 --owner=puppetforge --username=postgres --no-password puppetforge_test > /dev/null || {
	echo "Failed to create database" 1>&2
	exit 1
}
echo "Database puppetforge_test created!"

bundle exec rake db:migrate > /dev/null || {
	echo "Failed to migrate database" 1>&2
	exit 1
}
echo "Database migrated"
bundle exec rake db:populate:sample > /dev/null || {
	echo "Failed to populate database" 1>&2
	exit 1
}
echo "Database populated with samples"
bundle exec rake oauth2:sampleclient > /dev/null || {
	echo "Failed to create sample OAuth2 client" 1>&2
	exit 1
}
echo "Sample OAuth2 client added"
ruby script/server > "$LOG_FILE" 2>&1 &
echo $! > "$PID_FILE"
sleep 3
echo "Forge Server Started. Logfile=\"$LOG_FILE\", Pidfile=\"$PID_FILE\""
